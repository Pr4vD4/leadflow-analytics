# 2.3. Тестирование и отладка программных модулей программного продукта

## Разработка тестовых наборов и сценариев

В рамках разработки системы LeadFlow Analytics было начато внедрение тестирования с фокусом на ключевые компоненты системы. На текущем этапе охват тестами ограничен базовыми функциональными проверками:

### Модульные тесты (Unit Tests)

Для тестирования отдельных компонентов системы используется фреймворк PHPUnit. Основные направления модульного тестирования:

1. **Тестирование валидации данных**
   - Проверка корректной обработки валидных данных
   - Проверка корректной обработки невалидных данных

2. **Тестирование ключевых моделей**
   - Проверка базовых взаимосвязей между моделями
   - Тестирование вычисляемых атрибутов

3. **Тестирование компонентов ИИ-аналитики**
   - Проверка работы OllamaClient с моками
   - Тестирование обработки ответов от Ollama API

### Функциональные тесты

Разработаны базовые функциональные тесты, проверяющие:

1. **Работу API-интерфейса**
   - Создание заявок через API
   - Валидация входных данных
   - Аутентификация по API-ключу

2. **Основной функционал CRM**
   - Создание и редактирование заявок
   - Фильтрация и сортировка
   - Загрузка файлов

3. **Работу модуля ИИ-аналитики**
   - Базовое тестирование с использованием моков для OllamaClient
   - Проверка корректности обработки ответов от сервиса ИИ

### Интеграционные тесты

Разработаны простые интеграционные тесты для проверки:

1. **Взаимодействия компонентов**
   - Корректность работы системы событий
   - Взаимодействие контроллеров, сервисов и моделей

2. **Интеграции с внешними сервисами**
   - Базовая проверка работы с Ollama API с использованием тестовых моделей
   - Тестирование с использованием моков для имитации ответов от внешних сервисов

### Ручное тестирование

Дополнительно к автоматизированным тестам применяется ручное тестирование:

1. **Проверка пользовательского интерфейса**
   - Тестирование дизайна и удобства использования
   - Проверка интерактивных компонентов
   - Адаптивность на различных устройствах

2. **Сценарное тестирование**
   - Выполнение типичных пользовательских сценариев
   - Проверка процессов от создания до завершения заявки

## Планы по расширению тестирования

На будущих этапах разработки планируется расширить покрытие тестами и внедрить:

1. **Автоматизированное тестирование интерфейса**
   - Использование Dusk для тестирования веб-интерфейса
   - Проверка корректности работы интерактивных элементов

2. **Нагрузочное тестирование**
   - Проверка производительности API при различных уровнях нагрузки
   - Тестирование работы системы с большим объемом данных

## Отладка программных модулей

В процессе разработки системы применялись следующие методы отладки:

### 1. Логирование

Во всех модулях системы реализовано детальное логирование:

- **Уровни логирования**
  - Info: штатные операции системы
  - Warning: предупреждения о потенциальных проблемах
  - Error: ошибки в работе системы
  - Debug: детальная информация для отладки

- **Контекст логирования**
  - ID заявки и компании
  - Исходные данные запроса
  - Результаты выполнения операций
  - Трассировка ошибок

Особое внимание уделено логированию в модуле ИИ-аналитики:
- Запросы к Ollama API
- Время выполнения запросов
- Полученные ответы и их обработка
- Ошибки при взаимодействии с моделями

### 2. Мониторинг ошибок

Для отслеживания ошибок в работе системы используются следующие инструменты:

- **Laravel Telescope** - мониторинг запросов, очередей, событий
- **Laravel Debugbar** - отладка запросов к БД, производительности

### 3. Отладка взаимодействия с Ollama API

Для тестирования и отладки взаимодействия с Ollama API был создан специальный класс OllamaClient с подробным логированием:

- Фиксация всех запросов к API с указанием используемой модели
- Измерение времени выполнения запросов
- Логирование ошибок и неуспешных ответов
- Кэширование ответов для ускорения разработки и тестирования

### 4. Обработка ошибок

В системе реализована комплексная стратегия обработки ошибок:

- **Перехват и логирование исключений**
  - Централизованная обработка ошибок
  - Детальная информация для диагностики

- **Автоматическое восстановление**
  - Повторные попытки при сбоях внешних API
  - Механизмы отката операций при ошибках

- **Информативные сообщения**
  - Понятные сообщения для пользователей
  - Детальная техническая информация в логах

## Итоги тестирования

Проведенное тестирование позволило выявить и устранить ряд проблем:

1. **Обработка ошибок интеграции с ИИ-сервисами**
   - Улучшена обработка временной недоступности Ollama API
   - Добавлены механизмы повторных попыток и таймаутов

2. **Производительность и оптимизация**
   - Оптимизированы запросы к базе данных
   - Внедрено кэширование для повышения скорости работы

3. **Безопасность и валидация**
   - Улучшена валидация входных данных API
   - Устранены потенциальные уязвимости

В дальнейшем планируется расширить охват автоматическими тестами и внедрить непрерывную интеграцию (CI) для обеспечения стабильности при внесении изменений в систему. 
