# 2.2. Разработка программных модулей программного продукта

## Процесс разработки

Разработка системы LeadFlow Analytics велась по модульному принципу с использованием гибкой методологии Agile. Процесс включал следующие этапы:

1. **Подготовка и настройка проекта**
   - Создание базового Laravel 10 проекта
   - Настройка окружения разработки
   - Создание базовой структуры БД (миграции)

2. **Последовательная разработка модулей:**
   - Интеграционный модуль
   - Мини-CRM модуль
   - ИИ-аналитика модуль
   - Дашборд аналитики
   - Интеграция с Bitrix24

3. **Тестирование и оптимизация**
   - Написание тестов
   - Оптимизация запросов к БД

## Обоснование выбора средств разработки

Основными критериями при выборе инструментов разработки были эффективность, безопасность, масштабируемость и экосистема. В результате были выбраны:

- **PHP 8** с фреймворком **Laravel 10**:
  - Богатая экосистема пакетов
  - Встроенные механизмы безопасности
  - Удобный ORM (Eloquent) для работы с БД
  - Инструменты для создания REST API

- **Livewire** и **Tailwind CSS**:
  - Возможность создания динамических интерфейсов
  - Быстрая разработка прототипов
  - Адаптивный дизайн

## Разработка основных модулей

### 1. Интеграционный модуль

**Ключевые объекты:**

- **LeadController** - обработка API-запросов
- **CheckApiKey** - проверка API-ключей
- **Lead** - модель заявки

Реализован REST API для приема заявок с сайтов клиентов с аутентификацией через API-ключ и валидацией данных.

### 2. Мини-CRM модуль

**Ключевые объекты:**

- **LeadManagementController** - управление заявками
- **LeadsTable** - Livewire-компонент для отображения заявок
- **Lead** - модель заявки с встроенными статусами
- **LeadEvent** - модель для отслеживания изменений в заявках
- **FileUploadService** - загрузка файлов

Реализована таблица с фильтрацией, сортировкой и поиском заявок, а также формы для редактирования данных и управления связанными файлами.

### 3. ИИ-аналитика модуль

**Ключевые объекты:**

- **OllamaClient** - клиент для взаимодействия с Ollama API
- **LeadAnalyticsService** - сервис для генерации полного аналитического отчета по заявке
- **LeadRelevanceAnalyzer** - анализ релевантности заявки
- **LeadAnalytics** - модель для хранения результатов анализа

Модуль реализует широкий набор функций анализа заявок с использованием локальных ИИ-моделей через Ollama API:

1. **Категоризация заявок**
   - Автоматическое определение категории заявки (запрос информации, жалоба, консультация и т.д.)
   - Хранение категории в поле `category` модели Lead

2. **Суммаризация текста**
   - Создание краткого содержания заявки в 1-2 предложениях
   - Хранение в поле `summary` модели Lead

3. **Анализ тональности**
   - Определение тональности заявки (позитивная, нейтральная, негативная)
   - Хранение в поле `sentiment` модели LeadAnalytics

4. **Оценка срочности и сложности**
   - Определение срочности заявки по шкале от 1 до 10
   - Оценка сложности запроса по шкале от 1 до 10
   - Хранение в полях `urgency_score` и `complexity_score` модели LeadAnalytics

5. **Генерация ответов**
   - Создание шаблона ответа на заявку на основе ее содержания
   - Хранение в поле `generated_response` модели LeadAnalytics

6. **Выделение ключевых моментов**
   - Извлечение основных пунктов из сообщения клиента
   - Хранение в поле `key_points` модели LeadAnalytics

Все операции выполняются асинхронно с использованием очередей Laravel, чтобы не блокировать пользовательский интерфейс. Результаты анализа кэшируются для оптимизации повторных запросов.

### 4. Дашборд аналитики модуль

**Ключевые объекты:**

- **DashboardController** - отображение статистики
- **AnalyticsService** - агрегация данных
- **LeadRepository** - репозиторий для работы с заявками
- **LeadMetric** - модель для хранения агрегированных метрик

Реализована продвинутая система аналитики с различными возможностями:

1. **Динамическая фильтрация данных**
   - По периоду (день, неделя, месяц, квартал, год)
   - По источнику заявки
   - По статусу

2. **Расширенная визуализация**
   - Линейные графики динамики заявок
   - Круговые диаграммы распределения по источникам
   - Гистограммы конверсии

3. **Кэширование метрик**
   - Предварительный расчет и хранение метрик для повышения производительности
   - Автоматическое обновление при изменении данных

4. **Экспорт данных**
   - Выгрузка отчетов в CSV формат
   - Настраиваемые поля для экспорта

### 5. Интеграция с Bitrix24 модуль

**Ключевые объекты:**

- **Bitrix24Service** - взаимодействие с Bitrix24 API
- **SyncLeadToBitrix24Job** - синхронизация заявок
- **Bitrix24Integration** - настройки интеграции

Реализована передача данных из LeadFlow Analytics в Bitrix24 и обновление статусов заявок. Интеграция позволяет автоматически передавать новые заявки в Bitrix24 и синхронизировать их статусы между системами. Реализованы следующие функции:

1. **Настройка интеграции**
   - Конфигурация вебхука Bitrix24 в интерфейсе системы
   - Маппинг полей LeadFlow Analytics к полям Bitrix24

2. **Передача заявок**
   - Автоматическая передача новых заявок в Bitrix24
   - Отправка всех необходимых данных: контакты, источник, сообщение и т.д.

3. **Синхронизация статусов**
   - Обновление статуса заявки в Bitrix24 при изменении в LeadFlow Analytics
   - Отслеживание изменений через систему событий

4. **Асинхронная обработка**
   - Использование очередей для отправки данных в фоновом режиме
   - Повторные попытки при сбоях соединения

## Используемые объекты и их назначение

### Модели данных

1. **Lead** - заявка, основная сущность системы
   - Содержит основные поля: source, name, email, phone, message
   - Включает поле status для хранения статуса заявки (new, in_progress, completed, archived)
   - Содержит категорию и суммаризацию, рассчитанные ИИ
   - Хранит оценку релевантности (relevance_score)

2. **Company** - компания, реализация мультитенантности
   - Содержит API-ключ для интеграции
   - Хранит настройки интеграций

3. **LeadAnalytics** - аналитические данные по заявке
   - Хранит результаты анализа ИИ
   - Включает поля для тональности, срочности, сложности
   - Содержит сгенерированный ответ и ключевые моменты

4. **LeadEvent** - события, связанные с заявкой
   - Отслеживает изменения статуса и других полей
   - Хранит информацию о пользователе, внесшем изменения

5. **Tag** - тег заявки
   - Используется для категоризации заявок

6. **LeadFile** - файл, прикрепленный к заявке
   - Хранит информацию о загруженных файлах

7. **LeadMetric** - агрегированные метрики
   - Хранит предварительно рассчитанные статистические данные
   - Используется для ускорения формирования отчетов

8. **Bitrix24Integration** - настройки интеграции с Bitrix24
   - Хранит данные для подключения к Bitrix24 (webhook URL, токены)
   - Содержит настройки маппинга полей

### Сервисы

1. **OllamaClient** - базовый клиент для взаимодействия с Ollama API
   - Предоставляет методы для работы с локальными ИИ-моделями
   - Поддерживает генерацию текста, JSON и эмбеддингов

2. **LeadAnalyticsService** - сервис для полного анализа заявок
   - Использует OllamaClient для получения аналитических данных
   - Генерирует полный отчет о заявке

3. **LeadRelevanceAnalyzer** - анализ релевантности заявок
   - Оценивает важность и релевантность заявки по шкале от 1 до 10
   - Предоставляет объяснение оценки

4. **AnalyticsService** - агрегация данных для дашборда
   - Рассчитывает ключевые метрики
   - Подготавливает данные для графиков

5. **FileUploadService** - работа с файлами
   - Обрабатывает загрузку файлов
   - Управляет хранением и доступом к файлам

6. **Bitrix24Service** - взаимодействие с Bitrix24 API
   - Отправляет данные о заявках в Bitrix24
   - Синхронизирует статусы между системами
   - Обрабатывает ошибки внешнего API

### Репозитории

1. **LeadRepository** - репозиторий для работы с заявками
   - Инкапсулирует сложные запросы к БД
   - Обеспечивает фильтрацию и агрегацию данных

### Контроллеры

1. **Api\LeadController** - API для работы с заявками
2. **Crm\LeadController** - веб-интерфейс для управления заявками
3. **Crm\DashboardController** - статистика и аналитика
4. **Api\CompanyAnalysisController** - API для анализа данных компании
5. **Crm\SettingsController** - управление настройками компании и интеграциями
6. **Crm\Bitrix24Controller** - управление интеграцией с Bitrix24

### Livewire-компоненты

1. **LeadsTable** - таблица заявок с фильтрацией
2. **LeadEdit** - форма редактирования заявки
3. **Dashboard** - компоненты дашборда
4. **Bitrix24Settings** - форма настройки интеграции с Bitrix24

### Наблюдатели (Observers)

1. **LeadObserver** - отслеживает изменения в заявках
2. **LeadCommentObserver** - отслеживает добавление комментариев

### Очереди и задачи

1. **AnalyzeLeadJob** - анализ заявки с помощью ИИ
2. **SyncLeadToBitrix24Job** - синхронизация с Bitrix24

Использование очередей позволяет выполнять длительные операции (запросы к ИИ, интеграция с внешними API) без блокировки пользовательского интерфейса. 
